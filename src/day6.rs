use rayon::prelude::*;
use std::collections::HashSet;

pub fn run(input: &str) -> u32 {
    part2(input)
}

const DIR: [(i32, i32); 4] = [(-1, 0), (0, 1), (1, 0), (0, -1)];
const U: u8 = 0;
const R: u8 = 1;
const D: u8 = 2;
const L: u8 = 3;

unsafe fn walk1(map: &[u8], path: &mut [bool], ylen: i32, xlen: i32, n: i32) {
    path[n as usize] = true;
    let (mut y, mut x) = ((n / (xlen + 1)) as i32, (n % (xlen + 1)) as i32);
    let (mut dy, mut dx) = DIR[U as usize];
    loop {
        let (ny, nx) = (y + dy, x + dx);
        if ny < 0 || ny >= ylen || nx < 0 || nx >= xlen {
            break;
        }
        let nextpos = (ny * (xlen + 1) + nx) as usize;
        let ch = *map.get_unchecked(nextpos);
        if ch == b'#' {
            (dy, dx) = match (dy, dx) {
                (-1, _) => DIR[R as usize],
                (_, 1) => DIR[D as usize],
                (1, _) => DIR[L as usize],
                (_, _) => DIR[U as usize],
            };
        } else {
            *path.get_unchecked_mut(nextpos) = true;
            (y, x) = (ny, nx);
        }
    }
}

pub fn part1(input: &str) -> u32 {
    let map = input.as_bytes();
    let xlen = memchr::memchr(b'\n', map).unwrap() as i32;
    let ylen = (map.len() as i32 + 1) / (xlen + 1);
    let startpos = memchr::memchr(b'^', map).unwrap() as i32;
    let mut path = vec![false; map.len()];
    unsafe { walk1(map, &mut path, ylen, xlen, startpos) };
    path.iter()
        .filter(|&&visited| visited)
        .fold(0, |n, _| n + 1)
}

unsafe fn walk2(map: &[u8], ylen: i32, xlen: i32, n: i32) -> Vec<(i32, i32, u8)> {
    let mut path = Vec::new();
    path.push((n / (xlen + 1), n % (xlen + 1), U));
    let (mut y, mut x) = ((n / (xlen + 1)) as i32, (n % (xlen + 1)) as i32);
    let mut d = U;
    loop {
        let (dy, dx) = DIR.get_unchecked(d as usize);
        let (ny, nx) = (y + dy, x + dx);
        if ny < 0 || ny >= ylen || nx < 0 || nx >= xlen {
            break;
        }
        let nextpos = (ny * (xlen + 1) + nx) as usize;
        let ch = *map.get_unchecked(nextpos);
        if ch == b'#' {
            d = match d {
                U => R,
                R => D,
                D => L,
                L => U,
                _ => unreachable!(),
            };
        } else {
            path.push((ny, nx, d));
            (y, x) = (ny, nx);
        }
    }
    path
}

unsafe fn walk_is_loop(
    map: &[u8],
    path: &Vec<(i32, i32, u8)>,
    ylen: i32,
    xlen: i32,
    start: usize,
) -> bool {
    let (blockedy, blockedx) = (path[start].0, path[start].1);
    let blocked = blockedy * (xlen + 1) + blockedx;
    let mut visited = vec![0u8; map.len()];
    let (mut y, mut x, mut d) = path[start - 1];
    loop {
        let (dy, dx) = DIR.get_unchecked(d as usize);
        let (ny, nx) = (y + dy, x + dx);
        if ny < 0 || ny >= ylen || nx < 0 || nx >= xlen {
            break;
        }
        let nextpos = (ny * (xlen + 1) + nx) as usize;
        let ch = *map.get_unchecked(nextpos);
        if ch == b'#' || nextpos == blocked as usize {
            d = match d {
                U => R,
                R => D,
                D => L,
                L => U,
                _ => unreachable!(),
            };
            let currpos = (y * (xlen + 1) + x) as usize;
            if *visited.get_unchecked(currpos) & (1 << d) != 0 {
                return true;
            }
            *visited.get_unchecked_mut(currpos) |= 1 << d;
        } else {
            if *visited.get_unchecked(nextpos) & (1 << d) != 0 {
                return true;
            }
            *visited.get_unchecked_mut(nextpos) |= 1 << d;
            (y, x) = (ny, nx);
        }
    }
    false
}

pub fn part2(input: &str) -> u32 {
    let map = input.as_bytes();
    let xlen = memchr::memchr(b'\n', map).unwrap() as i32;
    let ylen = (map.len() as i32 + 1) / (xlen + 1);
    let startpos = memchr::memchr(b'^', map).unwrap() as i32;
    let path = unsafe { walk2(map, ylen, xlen, startpos) };
    let mut seen = HashSet::new();
    let mut cleanpath = Vec::new();
    for e in path {
        if seen.insert((e.0, e.1)) {
            cleanpath.push(e);
        }
    }
    (1..cleanpath.len())
        .into_par_iter()
        .filter(|&i| unsafe { walk_is_loop(map, &cleanpath, ylen, xlen, i as usize) })
        .count() as u32
}

pub const INPUT1: &str = "....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...";

pub const INPUT: &str = "......#.......#...................................................................................##......#..............#........
........................#....................................#....................................................................
...#.........#...#.....##..#...#......#..........................................#................#...................#....#....#.
....................#...#...#.#............#..................................#..............#....#...............................
.....................................................................#................................#...........................
........#............#......#................#..................#................................................#...............#
...................#.........#............................................................##......................................
.........#..........#......##.............#.#...............#................................##.................#.................
...........................................................#...............................#..................##......##.....#....
...................#...........................................##...............#.....#......#............#..........#............
...............#........................#...#....#..............................................#.#......#............#...........
........#.............#...........................#..#.....................................#......................................
......#......#....#..............#...............#...#...............#.......#...................................................#
..........#............#..#.....#......................#.........#...........................#..........#.........................
#...............................................................................#.#....#.............###..................#.......
.....#.#....#....................................#............................#...............#........................#....#.....
....#......#................#....................#...................#............#................#..............................
#...................#.............................#.#...#.............#......................#.....................#..............
.................#...............#................................#..##..#..............#.......#.................................
.....................................................##.#.....................................#.............#.....................
...#.............................#................................................................................................
#.##.........................................#....#..#..............................#......#..................................#...
......................#.........##.....................................#......................#..#..........#...............#....#
.#......................................................#....#......................................#...............#....#........
............#...............................#.......................................................#.............................
.............................................................................#....................................................
..#...#.....#...............................................................................................#.....................
................................................#.#.......................#..................#............#.......................
...............#.............#.....................#........................................................#..........#.......#..
...................................#..........#......#............................................#.....#.........................
.............#..............#...........##..........................................................................#.....#.......
.............#...............#........#.................................................................#.......#.................
.#...............................................................#..............................................................#.
.#......#...........#..............................................................##.............................................
...................#.....................................#....#........................#............................#.......###...
.....#...#.....#......................#.....................................#...............................#.....................
......................#....#...#........#........#...........................#...............#...........................#....#...
..#..#................................................................................#...........................................
.....#......#.#.......................................#..........#................................................................
..........#.......................#.............#.#........##.........................................................#...........
##........##.#....................#...#...................................................#.##......#...................#.........
...........#................#.#...........#......................#..................#......#......................................
...#..............................#......#...............#.................#.#............................................#.....#.
...#..................#...............#.........#..#.............................#..........#...................#.......#.........
.....................................................................................................#.......................#....
....................................##.#.................................#......##................................#.#.............
..................#.............................................................................................#............#....
............#........#...#.....#.....#........................................#....#..............#..............................#
....................................#...........................................................................................#.
............................#.#....#.....................#........................................................................
........#....#......#.......#................................................................##............................#......
....#...................#....#.............................................................................................#......
....................#......#.........................#..................#.........#....................#..........................
#........#.....#.......#....................................#.....#...........................................#...................
.....#....................................................................................................#.#....#................
....#....................................................................#.......#........................................#.......
#...........................#.#....#......#................................................................................#......
.#..........................................................#...............#......................#.............................#
..#..#.#...................................#.......#...............#....#....................#................................#...
.........................#........................................................................................................
...................................#...........................#...........#..#...........#................#.........#............
......................................#...............#.................#..#............................#.....#..#...#............
#.......................#.........#..#...............................................................#.......................#....
............#............................#..#.....................................................................................
................#............#..................#....#........#...............................#....#.#.......................#.#..
.........................................................................#....................#..........................#........
.....................................................#...............#........................................#......#............
..........##..................##...............................................................................................#..
..................#.........................................#..#......................#.........#.....#.....#.....................
..#.........................................................................#...................................#................#
...............................#..................................................................................................
..#..........#..#..............................................................................#........................#.........
...........#.#........................................................#.....#.........................#...........................
...........................................#......#...............................................................................
.......................#................................................................................................##........
.....#...............#....................................................................................#.......#...............
.#.#.................................#........................#................#...............#......#...........................
........#........#...............#.........................^...........................#......#.................................#.
.....................#.............#..#...........................................................................................
...........#...........................................................................#.......##......#.............#............
..........#..........................................#.................#....#......##.........#.................................#.
...................#...#...................#....#...........#................................#.#..................................
.......#....#...#..................#...............................................#.....#.........#......#.#.#.......#......#....
.....#................................................#......................#...#.....................................#.#........
.##........##.......#.........................................##..................................................................
......................................#....#........#..........#..#...........................#....................#....#.........
.......................#........................#..............................#.#.............................................#..
..........................#....###......................................................................#...................#.....
...........#..................#..............#....................................................................................
......................#................#..#............................#............#.........................##...#..............
.................#.......................................................................#....#...............................#...
................................................#..............................................................................#..
..#.......#....#................#...........................#..........#.#..#.......................#.#....................#......
........#.............................#........................................#..................................................
...........................#............................................................................#.............#....#......
#...................#.......#............#..........................................................#..#....#......#..........#..#
#..........#.................................#.........................#..................................#....................##.
..........#..#...........................................................................#........................##..........#...
.............#.#.......................................#.................................#..............#.......#.................
.................#....#........#........#....#.................................#................................#.................
...........................#..........#.#..#..#........#...#....................#...#........#.......................#............
........#................................#...................................#.#...............#..................................
............................................................#.......#......#.#..........................#..#....................#.
.........#.#....................................#.....................#.....##.......#..................................#.........
........#......................................#.......##............................................................##.....#.....
.............#................................#....#..................##...........................#..#..#........................
.......................................................#...#..........#...................................#.......#........#......
.....#...........#...............................................................................................#................
.......#..................#......#.....#............#..................#.......#.............#................#...................
.....#.........................................................#...........................................#.............#.....#..
...............#..................#...............................................#...................#...........................
..#............#......#....#...#..............................#..#...................................#...#.............#..........
.........#........#.....................................##.......................#.....................#..#.............#.........
....................#....#......................#..#.##..................#................#...........#............#..............
..........#..................................#............#..#...............#.................#..........#.......................
..................#.........#........................#.........................#.........#..................................#.....
...........#.#..............#........#.................................#............#............................#................
.#.....#........................................................................................#....#........##..................
.....................#....#.................#..........#............#............................#.............#.............#.#..
................................#....#......................................................#....#............#.............#.....
..............#..#.........#....................#.......................#.......#.........#..................#....................
.............#.....#....................#.#.....................#................#...#.........................#........##........
.......#.......................#.........................................#.........................##.....#...........#...#.....#.
.....#.................#................................................................#.................................#....#..
................#.......................#...........#........#................#.......#.#.#........................#........#.....
......#..........................#......#............#.......#...#.............................#..........##.......#..........#...
................#.....#...#..............................#......#..#..............................................................
.............................#....#...............#..............#......................................#.......###..#.#..........
..........#.......#...............#............................#........#.........................................................
.................#.....................................#.......................................#................#........#.#..#...";
